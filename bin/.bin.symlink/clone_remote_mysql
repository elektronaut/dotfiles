#!/usr/bin/env ruby

require "yaml"

remote_user = ENV["MYSQL_REMOTE_USER"]
remote_password = ENV["MYSQL_REMOTE_PASSWORD"]
environment = ARGV.first || "production"
deploy_file = "config/deploy/#{environment}.rb"
database_file = "config/database.yml"

unless remote_user && remote_password
  puts "ERROR: MYSQL_REMOTE_USER and MYSQL_REMOTE_PASSWORD not set."
  exit
end

if !File.exist?(database_file)
  puts "ERROR: Cannot find #{database_file}"
  exit
end

if !File.exist?(deploy_file)
  puts "ERROR: Cannot find #{deploy_file}"
  exit
end

remote_host = File.read(deploy_file).match(/server\s+['"]([^'"]*)/)[1]
db_config = YAML.load_file(database_file)
remote_database = db_config[environment]["database"]
local_database = db_config["development"]["database"]

puts "Cloning #{remote_host}/#{remote_database} to localhost/#{local_database}..."

`ssh #{remote_host} "mysqldump --add-drop-table --single-transaction --allow-keywords --add-drop-table --single-transaction --allow-keywords -u #{remote_user} -p#{remote_password} -h 127.0.0.1 --max_allowed_packet=100M #{remote_database}" | mysql -u root #{local_database}`
